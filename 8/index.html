<!doctype html>
<meta charset="utf-8" />
<style>
    body {
        margin: 0;
        overflow: hidden;
        position: fixed;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
    }

    svg {
        position: absolute;
        left: 50%;
        top: 50%;
        overflow: visible;
    }
</style>

<svg></svg>

<script src="../d3/d3.min.js"></script>
<script>
    "use strict";
    var gap = 30;
    var svg = d3.select("svg")
        .attr("width", 100)
        .attr("height", 100)
    function Arrow(cx, cy) {
        this.r = 15;
        this.e = 0.2;
        this.rotate = 0;
        this.cx = cx * gap;
        this.cy = cy * gap;
        this.arrow = svg.append("g");
        var path = d3.path();
        path.moveTo(this.cx + this.r, this.cy);
        path.lineTo(this.cx, this.cy + this.e * this.r);
        path.lineTo(this.cx, this.cy - this.e * this.r);
        path.closePath();
        this.arrow.append("path")
            .attr("d", path.toString())
            .style("fill", "red");
        path = d3.path();
        path.moveTo(this.cx - this.r, this.cy);
        path.lineTo(this.cx, this.cy + this.e * this.r);
        path.lineTo(this.cx, this.cy - this.e * this.r);
        path.closePath();
        this.arrow.append("path")
            .attr("d", path.toString())
            .style("fill", "blue");
        this.arrow.append("circle")
            .attr("cx", this.cx)
            .attr("cy", this.cy)
            .attr("r", 3)
            .style("stroke", "aqua")
            .style("fill", "black")
        this.arrow.attr("transform", "rotate(" + this.rotate + "," + this.cx + " " + this.cy + ")");
    }

    Arrow.prototype.refresh = function (x, y) {
        // if you let the mouse be a magnet:
        // var dx = x - this.cx;
        // var dy = y - this.cy;
        // var dis2 = dx * dx + dy * dy;
        // var forceX = dx / dis2;
        // var forceY = dy / dis2;
        var forceX = 0;
        var forceY = 0;

        Magnets.forEach((m) => {
            var dx = m.x - this.cx;
            var dy = m.y - this.cy;
            var dis2 = dx * dx + dy * dy;
            forceX += m.strength * dx / dis2;
            forceY += m.strength * dy / dis2;
        })

        this.rotate = Math.atan(forceY / forceX) / Math.PI * 180;
        if (forceX < 0) {
            this.rotate += 180;
        }
        this.arrow.attr("transform", "rotate(" + this.rotate + "," + this.cx + " " + this.cy + ")");
    }

    var Arrows = [];
    var Magnets = [];

    for (var i = -Math.floor(window.screen.width / 2 / gap); i <= Math.floor(window.screen.width / 2 / gap); i++) {
        for (var j = -Math.floor(window.screen.height / 2 / gap); j <= Math.floor(window.screen.height / 2 / gap); j++) {
            Arrows.push(new Arrow(i, j));
        }
    }

    function refresh(event) {
        Arrows.forEach(function (a) {
            a.refresh(event.clientX - window.innerWidth / 2, event.clientY - window.innerHeight / 2);
        })
    }
    function placeMagnet(event) {
        var magnet = {
            x: event.clientX - window.innerWidth / 2,
            y: event.clientY - window.innerHeight / 2,
            strength: event.button - 1
        }
        Magnets.push(magnet);
        svg.append("circle")
            .attr("cx", magnet.x)
            .attr("cy", magnet.y)
            .attr("r", 20)
            .style("fill", event.button === 0 ? "red" : "blue")
            .on("click", checkMagnets)
        refresh(event);
    }

    // if you let the mouse be a magnet:
    //document.body.onmousemove = refresh;

    document.body.onmousedown = placeMagnet;
    document.body.oncontextmenu = () => false;

</script>